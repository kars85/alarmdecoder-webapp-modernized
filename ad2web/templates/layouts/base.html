<!DOCTYPE html>
<html lang="en" class="h-100"> 
    <!-- Added lang and h-100 for sticky footer -->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>{% block title %}{{ page_title|default(_('Project')) }}{% endblock %}</title>
        <meta name="description" content="The AlarmDecoder Webapp provides a standard interface across all of your devices for your alarm card.">
        <meta name="author" content="Nu Tech Software Solutions, Inc.">
        <!-- Standard BS5 Viewport -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Favicon -->
        <link rel="Shortcut Icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
        {% block permanent_css %}
        <!-- Bootstrap 5 CSS -->
        <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap5/css/bootstrap.min.css') }}">
        <!-- Bootstrap Toggle CSS (Review compatibility later) -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.toggle.min.css') }}">
        <!-- DataTables BS5 CSS -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/dataTables.bootstrap5.min.css') }}">
        <!-- Removed link to old datatables.min.css -->
        <!-- Main Responsive CSS (Review Heavily or Remove) -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/main_responsive.css') }}">
        <!-- User Custom CSS (Review) -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/user_custom.css') }}">
        {% endblock %}
        {% block css %}
        <!-- Removed jQuery UI CSS -->
        {% endblock %}
        {% block css_style %}
        <!-- Optional: Add inline styles if needed -->
        <style>
      /* Ensure body takes full height for Flexbox sticky footer */
      /* body { display: flex; flex-direction: column; min-height: 100vh; } */ /* Provided by h-100 on html and d-flex on body */
      /* main { flex: 1 0 auto; } */ /* Provided by flex-grow-1 on main wrapper */
      /* footer { flex-shrink: 0; } */ /* Default footer behavior */
    </style>
        {% endblock %}
        {% block js_top %}
        <!-- Removed Modernizr, FastClick, and inline viewport script -->
        <script type="text/javascript">
        // Placeholder for tooltip function. Review usage and replace with BS5 Tooltips.
        function createFormTooltip(element, text) {
            // TODO: Replace with BS5 Tooltip initialization if needed, or remove if unused.
            // Requires Popper (included in BS5 bundle). Initialize via JS or data attributes.
             console.warn('createFormTooltip called - Ensure replacement with BS5 Tooltips: ', element, text);
             if (typeof $ !== 'undefined') { // Temporary check if jQuery still exists
                 $(element).prop('title', text); // This alone doesn't activate BS5 tooltip
             }
        }
    </script>
        {% endblock %}
    </head>
    <body class="d-flex flex-column h-100"> 
        <!-- Flex classes for sticky footer -->
        {% block topbar %}
        <!-- BS5 Navbar Structure -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm mb-3"> 
            <!-- Adjusted classes -->
            <div class="container"><a class="navbar-brand" href="{{ url_for('frontend.index') }}"> <img src="{{ url_for('static', filename='img/logo.png') }}" alt="AlarmDecoder Logo" style="height: 30px; width: auto;"/> <!-- Added alt text --> </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMainCollapse" aria-controls="navbarMainCollapse" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarMainCollapse">
                    <ul class="navbar-nav ms-auto mb-2 mb-lg-0"> 
                        <!-- Use ms-auto for right alignment -->
                        {% if user_is_authenticated(current_user) %}
                        {% if update_available and current_user.is_admin() %}
                        <li class="nav-item"><a class="nav-link text-success" href="{{ url_for('update.index') }}">Update Available!</a> 
                            <!-- Use BS5 text color utility -->
                        </li>
                        {% endif %}
                        {% if firmware_update_available and current_user.is_admin() %}
                        <li class="nav-item"><a class="nav-link text-success" href="{{ url_for('update.update_firmware') }}">Firmware Update Available!</a>
                        </li>
                        {% endif %}
                        <li class="nav-item"><a class="nav-link {% if request.endpoint.startswith('keypad.') %}active{% endif %}" href="{{ url_for('keypad.index') }}">Keypad</a> 
                            <!-- Added active class example -->
                        </li>
                        {% if cameras is defined and cameras != 0 %}
                        <li class="nav-item"><a class="nav-link {% if request.endpoint.startswith('cameras.') %}active{% endif %}" href="{{ url_for('cameras.index') }}">Cameras</a>
                        </li>
                        {% endif %}
                        <li class="nav-item"><a class="nav-link {% if request.endpoint.startswith('log.') %}active{% endif %}" href="{{ url_for('log.events') }}">Log</a>
                        </li>
                        <li class="nav-item"><a class="nav-link {% if request.endpoint.startswith('settings.') %}active{% endif %}" href="{{ url_for('settings.index') }}">Settings</a>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('frontend.logout') }}">Log out</a>
                        </li>
                        {% else %}
                        <li class="nav-item"><a class="nav-link {% if request.endpoint.startswith('frontend.login') %}active{% endif %}" href="{{ url_for('frontend.login') }}">Sign in</a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <!-- /.navbar-collapse -->
            </div>
            <!-- /.container -->
        </nav>
        {% endblock %}
        <!-- Main content wrapper for Flexbox sticky footer -->
        <main class="flex-grow-1"> 
            <!-- Use <main> tag and flex-grow-1 -->
            {% block flash_message %}
            <div class="container">
                <div id='flash_message_container'>
                    {% with messages = get_flashed_messages(with_categories=True) %}
                    {% if messages %}
                    {% for category, msg in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert"> 
                        <!-- Added dismissible classes -->
                        {{ msg }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>                         

                        <!-- BS5 close button -->
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}
                </div>
            </div>
            {% endblock %}
            {% block container %}
            <div class="container">
                <noscript>
                    <div id="nojs" class="alert alert-warning" role="alert"> 
                        <!-- Using BS5 alert -->
                        <p class="mb-0">This application makes heavy use of Javascript and the majority of it will not function without it. Please enable Javascript in your browser.</p>
                    </div>
                </noscript>
                {% block top %}
                {% if tabs %}
                <div class="mb-3"> 
                    <!-- Simplified wrapper, added margin -->
                    <ul class="nav nav-tabs">
                        {% for tab, link, admin_required in tabs %}
                        {% if not admin_required or current_user.is_admin() %}
                        <li class="nav-item"> 
                            <!-- Added nav-item --><a class="nav-link {% if active == tab %}active{% endif %}" href="{{ link }}">{{ tab|capitalize }}</a> 
                            <!-- Added nav-link -->
                        </li>
                        {% endif %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                {% endblock %}
                {% block body %}
                {% endblock %}
            </div>
            {% endblock %}
        </main>         

        <!-- End main content wrapper -->
        {% block footer %}
        <!-- Footer adjusted for Flex sticky footer -->
        <footer class="footer mt-auto py-3 bg-light border-top"> 
            <!-- mt-auto is key, added border -->
            <div class="container text-center">
                <ul class="list-inline mb-0"> 
                    <!-- Use list-inline for simpler spacing -->
                    <li class="list-inline-item">© 2024</li>                     

                    <!-- Updated year -->
                    <li class="list-inline-item text-body-secondary">·</li>                     

                    <!-- BS5 muted -->
                    <li class="list-inline-item"><a href="https://www.alarmdecoder.com/">AlarmDecoder</a>
                    </li>
                    <li class="list-inline-item text-body-secondary">·</li>
                    <li class="list-inline-item"><a href="{{ url_for('frontend.help') }}">Help</a>
                    </li>
                    <li class="list-inline-item text-body-secondary">·</li>
                    <li class="list-inline-item"><a href="{{ url_for('frontend.license') }}">Terms</a>
                    </li>
                    <li class="list-inline-item text-body-secondary">·</li>
                    <li class="list-inline-item text-body-secondary">v{{ version }}</li>                     

                    <!-- BS5 muted -->
                </ul>
            </div>
        </footer>
        {% endblock %}
        {% block perm_js %}
        <!-- jQuery first (needed by plugins) -->
        <script src="{{ url_for('static', filename='js/vendor/jquery-2.0.3.min.js') }}"></script>
        <!-- Bootstrap 5 Bundle JS (includes Popper) -->
        <script src="{{ url_for('static', filename='bootstrap5/js/bootstrap.bundle.min.js') }}"></script>
        <!-- Review plugins.js: what's inside? compatible? -->
        <script src="{{ url_for('static', filename='js/plugins.js') }}"></script>
        <!-- Mobile Detect (if needed) -->
        <script src="{{ url_for('static', filename='js/vendor/mobile-detect.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/vendor/mobile-detect-modernizr.js') }}"></script>
        {% endblock %}
        {% block js_btm %}
        <!-- DataTables Core JS -->
        <script src="{{ url_for('static', filename='js/vendor/datatables.min.js') }}"></script>
        <!-- DataTables BS5 Integration JS -->
        <script src="{{ url_for('static', filename='js/vendor/dataTables.bootstrap5.min.js') }}"></script>
        <!-- Other jQuery Plugins -->
        <script src="{{ url_for('static', filename='js/vendor/spin.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/vendor/jquery.spin.js') }}"></script>
        <script src="{{ url_for('static', filename='js/vendor/jquery.confirm.min.js') }}"></script>
        <!-- Removed jQuery UI JS -->
        {% endblock %}
        {% block appjs %}
        <!-- Core App JS (Review for jQuery/BS3 dependencies) -->
        <script src="{{ url_for('static', filename='js/vendor/socket.io.js') }}"></script>
        <script src="{{ url_for('static', filename='js/vendor/pubsub.js') }}"></script>
        <script src="{{ url_for('static', filename='js/alarmdecoder.js') }}"></script>
        <script src="{{ url_for('static', filename='js/main.js') }}"></script>
        {% endblock %}
        {% block pagejs %}
        <!-- Page specific JS injections -->
        {% endblock %}
        {% block ga %}
        {% include "macros/_google_analytics.html" %}
        {% endblock %}
    </body>
</html>